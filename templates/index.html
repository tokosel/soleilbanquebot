<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant Virtuel - Baobab Sénégal</title>
    <!-- TailwindCSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue.js via CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Custom styles -->
    <style>
        .chat-container {
            max-height: 60vh;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        .loader {
            border-top-color: #3498db;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8">
        <!-- En-tête -->
        <header class="flex items-center justify-between mb-8">
            <div class="flex items-center">
                <h1 class="text-3xl font-bold text-green-700">Assistant Virtuel Baobab</h1>
            </div>
            <div class="text-sm text-gray-500" v-if="status">
                Statut: <span class="font-semibold" :class="{'text-green-500': status === 'online', 'text-yellow-500': status === 'initializing'}">{{ status }}</span>
            </div>
        </header>

        <div class="bg-white rounded-lg shadow-lg p-6">
            <!-- Interface principale -->
            <div class="mb-6">
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">Comment puis-je vous aider aujourd'hui ?</h2>
                    <p class="text-gray-600">
                        Posez vos questions sur l'ouverture de compte, les prêts, l'épargne, 
                        les microcrédits ou les documents requis pour vos démarches.
                    </p>
                </div>

                <!-- Zone de chat -->
                <div class="chat-container bg-gray-50 rounded-lg p-4 mb-4" ref="chatContainer">
                    <div v-if="messages.length === 0" class="text-center text-gray-400 py-8">
                        Commencez la conversation en posant une question ci-dessous.
                    </div>
                    <div v-for="(message, index) in messages" :key="index" class="mb-4">
                        <div v-if="message.role === 'user'" class="flex justify-end">
                            <div class="bg-green-100 text-gray-800 rounded-lg py-2 px-4 max-w-[80%]">
                                {{ message.content }}
                            </div>
                        </div>
                        <div v-else class="flex justify-start">
                            <div class="bg-white border border-gray-200 text-gray-800 rounded-lg py-2 px-4 max-w-[80%] shadow-sm">
                                <div v-html="formatMessage(message.content)"></div>
                                <div v-if="message.sources && message.sources.length > 0" class="mt-2 text-xs text-gray-500">
                                    Sources: 
                                    <span v-for="(source, idx) in message.sources" :key="idx" class="mr-1">
                                        {{ source }}{{ idx < message.sources.length - 1 ? ',' : '' }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div v-if="isLoading" class="flex justify-center py-4">
                        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10"></div>
                    </div>
                </div>

                <!-- Input utilisateur -->
                <div class="flex space-x-2">
                    <input 
                        type="text" 
                        v-model="userInput" 
                        @keyup.enter="sendMessage"
                        placeholder="Posez votre question ici..." 
                        class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500"
                        :disabled="isLoading || !isReady"
                    />
                    <button 
                        @click="sendMessage" 
                        class="bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500"
                        :disabled="isLoading || !isReady || !userInput.trim()"
                    >
                        Envoyer
                    </button>
                </div>
            </div>

            <!-- Téléchargement de documents -->
            <div class="mt-8 border-t pt-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Télécharger un document</h3>
                <p class="text-sm text-gray-600 mb-4">
                    Téléchargez des documents PDF, DOCX, TXT ou HTML pour enrichir la base de connaissances du chatbot.
                </p>
                
                <div class="flex items-center space-x-4">
                    <input 
                        type="file" 
                        ref="fileInput"
                        @change="handleFileSelected" 
                        accept=".pdf,.docx,.txt,.html"
                        class="hidden"
                    />
                    <button 
                        @click="$refs.fileInput.click()" 
                        class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium rounded-lg px-4 py-2"
                        :disabled="isUploading"
                    >
                        Sélectionner un fichier
                    </button>
                    <div v-if="selectedFile" class="text-sm">
                        <span class="font-medium">{{ selectedFile.name }}</span>
                        <span class="text-gray-500 ml-2">({{ formatFileSize(selectedFile.size) }})</span>
                    </div>
                    <button 
                        v-if="selectedFile" 
                        @click="uploadFile" 
                        class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-4 py-2"
                        :disabled="isUploading"
                    >
                        {{ isUploading ? 'Téléchargement...' : 'Télécharger' }}
                    </button>
                </div>
                <div v-if="uploadMessage" class="mt-2 text-sm" :class="{'text-green-600': uploadSuccess, 'text-red-600': !uploadSuccess}">
                    {{ uploadMessage }}
                </div>
            </div>
        </div>

        <!-- Pied de page -->
        <footer class="mt-8 text-center text-sm text-gray-500">
            <p>© 2025 Baobab Sénégal - Assistant Virtuel</p>
        </footer>
    </div>

    <!-- Script Vue.js -->
    <script>
        const { createApp, ref, onMounted, nextTick, watch } = Vue;

        createApp({
            setup() {
                const userInput = ref('');
                const messages = ref([]);
                const isLoading = ref(false);
                const chatContainer = ref(null);
                const isReady = ref(false);
                const status = ref('initializing');
                const fileInput = ref(null);
                const selectedFile = ref(null);
                const isUploading = ref(false);
                const uploadMessage = ref('');
                const uploadSuccess = ref(false);

                // Formater le message pour afficher les sauts de ligne
                const formatMessage = (message) => {
                    return message.replace(/\n/g, '<br>');
                };

                // Formater la taille du fichier
                const formatFileSize = (bytes) => {
                    if (bytes < 1024) return bytes + ' octets';
                    else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' Ko';
                    else return (bytes / 1048576).toFixed(1) + ' Mo';
                };

                // Envoyer un message
                const sendMessage = async () => {
                    const message = userInput.value.trim();
                    if (!message || isLoading.value || !isReady.value) return;

                    // Ajouter le message utilisateur
                    messages.value.push({
                        role: 'user',
                        content: message
                    });
                    
                    userInput.value = '';
                    isLoading.value = true;

                    // Faire défiler vers le bas
                    await scrollToBottom();

                    try {
                        // Envoyer la requête au serveur
                        const response = await fetch('/api/chat', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ query: message })
                        });

                        const data = await response.json();

                        if (data.success) {
                            // Ajouter la réponse du chatbot
                            messages.value.push({
                                role: 'assistant',
                                content: data.answer,
                                sources: data.sources
                            });
                        } else {
                            // Ajouter un message d'erreur
                            messages.value.push({
                                role: 'assistant',
                                content: data.error || "Une erreur est survenue. Veuillez réessayer."
                            });
                        }
                    } catch (error) {
                        console.error('Erreur:', error);
                        // Ajouter un message d'erreur
                        messages.value.push({
                            role: 'assistant',
                            content: "Désolé, une erreur de connexion est survenue. Veuillez réessayer plus tard."
                        });
                    } finally {
                        isLoading.value = false;
                        // Faire défiler vers le bas
                        await scrollToBottom();
                    }
                };

                // Vérifier le statut du serveur
                const checkStatus = async () => {
                    try {
                        const response = await fetch('/api/status');
                        const data = await response.json();
                        status.value = data.status;
                        isReady.value = data.ready;

                        if (!data.ready) {
                            // Réessayer dans 5 secondes
                            setTimeout(checkStatus, 5000);
                        }
                    } catch (error) {
                        console.error('Erreur lors de la vérification du statut:', error);
                        status.value = 'error';
                        setTimeout(checkStatus, 10000);
                    }
                };

                // Gérer la sélection de fichier
                const handleFileSelected = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        selectedFile.value = file;
                        uploadMessage.value = '';
                    }
                };

                // Télécharger un fichier
                const uploadFile = async () => {
                    if (!selectedFile.value || isUploading.value) return;

                    isUploading.value = true;
                    uploadMessage.value = '';
                    
                    try {
                        const formData = new FormData();
                        formData.append('file', selectedFile.value);

                        const response = await fetch('/api/upload', {
                            method: 'POST',
                            body: formData
                        });

                        const data = await response.json();
                        
                        if (data.success) {
                            uploadMessage.value = data.message;
                            uploadSuccess.value = true;
                            selectedFile.value = null;
                            fileInput.value.value = '';
                            
                            // Mettre à jour le statut
                            setTimeout(checkStatus, 2000);
                        } else {
                            uploadMessage.value = data.error || "Échec du téléchargement";
                            uploadSuccess.value = false;
                        }
                    } catch (error) {
                        console.error('Erreur lors du téléchargement:', error);
                        uploadMessage.value = "Erreur de connexion lors du téléchargement";
                        uploadSuccess.value = false;
                    } finally {
                        isUploading.value = false;
                    }
                };

                // Faire défiler vers le bas de la conversation
                const scrollToBottom = async () => {
                    await nextTick();
                    if (chatContainer.value) {
                        chatContainer.value.scrollTop = chatContainer.value.scrollHeight;
                    }
                };

                // Initialisation
                onMounted(() => {
                    checkStatus();
                });

                // Surveiller les changements de messages pour faire défiler vers le bas
                watch(messages, async () => {
                    await scrollToBottom();
                });

                return {
                    userInput,
                    messages,
                    sendMessage,
                    isLoading,
                    chatContainer,
                    isReady,
                    status,
                    fileInput,
                    selectedFile,
                    handleFileSelected,
                    uploadFile,
                    isUploading,
                    uploadMessage,
                    uploadSuccess,
                    formatFileSize,
                    formatMessage
                };
            }
        }).mount('#app');
    </script>
</body>
</html>